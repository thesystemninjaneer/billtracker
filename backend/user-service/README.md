# User Service Microservice

This uses a Node.js Express application for the User Service. The following assumes the backend DB service has already been configured and tested per [its README.md](../db/README.md). The below must be done before the next dependent service in [../organization-service](../organization-service/README.md).

1. breakdown

- express: Web framework.
- mysql2: MySQL client for Node.js.
- dotenv: For loading environment variables.
- cors: For handling Cross-Origin Resource Sharing.
- bcryptjs: For hashing passwords securely.
- jsonwebtoken: For creating and verifying JWTs.

2. config file `.env`

Important: Replace `your_jwt_secret_key_very_long_and_random` with a truly random and complex string (e.g., generated by `node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"`).

3. User Service Code

main application file: `backend/user-service/server.js`.

4. containerized user service

The Dockerfile in backend/user-service containerizes the service.

5. Integrated User Service 

The Dockerfile is included in the `./my-bill-tracker/docker-compose.yaml` file.

## Running the backend service

```
./billtracker$ docker compose -f my-bill-tracker/docker-compose.yaml up --build
```

This command will:
- Build the user-service Docker image.
- Recreate organization-service if its Dockerfile changed (though it shouldn't have).
- Ensure all services are running and healthy.

check logs
```
./billtracker$ docker logs bill-tracker-user-service -f
```
You should see User Service: `Connected to MySQL database! and User Service running on port 3000.`

### Testing 

After performing the above to run the backend services, do the following to verify API functionality of the user-service microservice.

1. Test 1: curl to test your User Service APIs.

The base URL for your User Service will be http://localhost:3000.
- Register User (POST):
  - URL: http://localhost:3000/register
  - Method: POST
  - Headers: Content-Type: application/json
  - Body (raw JSON):
    ```json
    {
        "username": "testuser",
        "email": "test@example.com",
        "password": "password123"
    }
    ```
  - Expected Response: A 201 Created status with userId and a token.
  - Ex:
    ```sh
    DATA='{ "username": "testuser", "email": "test@example.com", "password": "password123" }'
    curl http://localhost:3000/register -X POST -d "$DATA" -H 'Content-Type: application/json'
    {"message":"User registered successfully","userId":1,"token":"xxxxxxxxxxxxxxxxxxxxxxxxxxxx","user":{"id":1,"username":"testuser"}}
    ```
    - TIP: add the returned values into a file (eg, `~/accounts/billtracker.txt`) like shown below to simplify future logins when testing other API's under development.
      ```
      USER=testuser
      EMAIL=test@example.com
      PW=password123
      TOKEN=xxxxxxxxxxxxxxxxxxxx
      ```

2. login to user service

- Login User (POST):
  - URL: http://localhost:3000/login
  - Method: POST
  - Headers: Content-Type: application/json, Body (raw JSON):
    ```json
    {
       "username": "testuser",
       "password": "password123"
    }
    ```
  - Expected Response: A 200 OK status with a token and user object. Copy this token!
  - Ex:
    ```
    source ~/accounts/billtracker.txt
    DATA="
    { \"username\": \"$USER\", \"email\": \"$EMAIL\", \"password\": \"$PW\" }"
    curl http://localhost:3000/login -X POST -d "$DATA" -H 'Content-Type: application/json'
    {"message":"Logged in successfully","token":"xxxxxxxxxxxxxxxxxxxxxxxxx","user":{"id":1,"username":"testuser"}
    ```
- Get User Profile (GET - Protected Route):
  - URL: http://localhost:3000/profile
  -  Method: GET
  -  Headers:
     - Content-Type: application/json
     - Authorization: Bearer YOUR_JWT_TOKEN_HERE (Replace YOUR_JWT_TOKEN_HERE with the token obtained from the login response).
  - Expected Response: A 200 OK status with user profile details.

Test without token: If you omit the Authorization header or provide an invalid token, you should get a 401 Unauthorized or 403 Forbidden response.


This functional User Service uses secure password hashing and JWT-based authentication!

Perform Test 1 to generate a user account password before moving on to other services. You'll need it's password when testing any other API endpoints. To setup the next most relevant service, follow the [../organization-service README](../organization-service/README.md).